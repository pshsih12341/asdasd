"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useListKeydown = void 0;
const tslib_1 = require("tslib");
const react_1 = tslib_1.__importDefault(require("react"));
const constants_1 = require("../../../constants");
const findNextIndex_1 = require("../utils/findNextIndex");
const scrollToListItem_1 = require("../utils/scrollToListItem");
// Use this hook if you need keyboard support for tree structure lists
const useListKeydown = ({ containerRef, onItemClick, enabled, list }) => {
    const activateItem = react_1.default.useCallback((index, scrollTo = true) => {
        var _a, _b;
        if (typeof index === 'number' && list.structure.visibleFlattenIds[index]) {
            if (scrollTo) {
                (0, scrollToListItem_1.scrollToListItem)(list.structure.visibleFlattenIds[index], containerRef === null || containerRef === void 0 ? void 0 : containerRef.current);
            }
            (_b = (_a = list.state).setActiveItemId) === null || _b === void 0 ? void 0 : _b.call(_a, list.structure.visibleFlattenIds[index]);
        }
    }, [list.structure.visibleFlattenIds, list.state, containerRef]);
    const handleKeyMove = react_1.default.useCallback((event, step, defaultItemIndex = 0) => {
        event.preventDefault();
        const maybeIndex = typeof list.state.activeItemId === 'string'
            ? list.structure.visibleFlattenIds.findIndex((i) => i === list.state.activeItemId)
            : -1;
        const nextIndex = (0, findNextIndex_1.findNextIndex)({
            list: list.structure.visibleFlattenIds,
            index: (maybeIndex > -1 ? maybeIndex : defaultItemIndex) + step,
            step: Math.sign(step),
            disabledItemsById: list.state.disabledById,
        });
        activateItem(nextIndex);
    }, [
        activateItem,
        list.state.activeItemId,
        list.state.disabledById,
        list.structure.visibleFlattenIds,
    ]);
    react_1.default.useLayoutEffect(() => {
        const anchor = containerRef === null || containerRef === void 0 ? void 0 : containerRef.current;
        if (enabled || !anchor) {
            return undefined;
        }
        const handleKeyDown = (event) => {
            switch (event.key) {
                case constants_1.KeyCode.ARROW_DOWN: {
                    handleKeyMove(event, 1, -1);
                    break;
                }
                case constants_1.KeyCode.ARROW_UP: {
                    handleKeyMove(event, -1);
                    break;
                }
                case constants_1.KeyCode.SPACEBAR:
                case constants_1.KeyCode.ENTER: {
                    if (list.state.activeItemId &&
                        !list.state.disabledById[list.state.activeItemId]) {
                        event.preventDefault();
                        onItemClick === null || onItemClick === void 0 ? void 0 : onItemClick({ id: list.state.activeItemId });
                    }
                    break;
                }
                default: {
                }
            }
        };
        anchor.addEventListener('keydown', handleKeyDown);
        return () => {
            anchor.removeEventListener('keydown', handleKeyDown);
        };
    }, [
        containerRef,
        enabled,
        handleKeyMove,
        list.state.activeItemId,
        list.state.disabledById,
        onItemClick,
    ]);
};
exports.useListKeydown = useListKeydown;
